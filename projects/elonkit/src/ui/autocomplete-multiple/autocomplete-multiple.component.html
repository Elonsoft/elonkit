<div class="es-autocomplete-multiple es-subtitle-1">
  <div class="es-autocomplete-multiple__value">
    <mat-chip-list *ngIf="value.length" class="es-autocomplete-multiple__chip-list" #chipList>
      <mat-chip
        *ngFor="let option of this.value; index as i"
        class="es-autocomplete-multiple__chip es-body-100"
        removable
        (removed)="onRemove(i)"
      >
        {{ displayWith(option) }}

        <mat-icon matChipRemove svgIcon="es-autocomplete-multiple:clear-small"></mat-icon>
      </mat-chip>

      <div *ngIf="hiddenChipCount" class="es-autocomplete-multiple__count es-caption">
        +{{ hiddenChipCount }}
      </div>
    </mat-chip-list>
  </div>

  <button
    *ngIf="value.length"
    class="es-autocomplete-multiple__clear"
    mat-icon-button
    (click)="onRemoveAll($event)"
  >
    <mat-icon svgIcon="es-autocomplete-multiple:clear"></mat-icon>
  </button>

  <button
    #arrow
    class="es-autocomplete-multiple__arrow"
    mat-icon-button
    [attr.aria-describedby]="describedBy"
  >
    <mat-icon
      svgIcon="es-autocomplete-multiple:{{ this.isOpen ? 'menu-up' : 'menu-down' }}"
    ></mat-icon>
  </button>
</div>

<ng-template
  cdkConnectedOverlay
  cdkConnectedOverlayHasBackdrop
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  [cdkConnectedOverlayOffsetY]="8"
  [cdkConnectedOverlayOrigin]="origin"
  [cdkConnectedOverlayOpen]="isOpen"
  (backdropClick)="onClose()"
  (detach)="onClose(true)"
>
  <div
    *ngIf="locale$ | async as locale"
    class="es-autocomplete-multiple__panel mat-elevation-z8"
    [ngStyle]="{ 'width.px': width }"
    [formGroup]="form"
    cdkTrapFocus
    @panel
  >
    <mat-button-toggle-group formControlName="scope" class="es-autocomplete-multiple__toggle-group">
      <mat-button-toggle
        class="es-autocomplete-multiple__button-toggle es-body-100"
        [value]="searchScope.ALL"
        >{{ locale.autocompliteMultiple.labelTabAll }}</mat-button-toggle
      >
      <mat-button-toggle
        class="es-autocomplete-multiple__button-toggle es-body-100"
        [value]="searchScope.SELECTED"
        >{{ locale.autocompliteMultiple.labelTabSelected }}</mat-button-toggle
      >
      <mat-button-toggle
        class="es-autocomplete-multiple__button-toggle es-body-100"
        [value]="searchScope.NOT_SELECTED"
        >{{ locale.autocompliteMultiple.labelTabNotSelected }}</mat-button-toggle
      >
    </mat-button-toggle-group>

    <div class="es-autocomplete-search">
      <mat-icon
        class="es-autocomplete-search__icon"
        matPrefix
        svgIcon="es-autocomplete-multiple:magnify"
      ></mat-icon>
      <input
        #input
        class="es-autocomplete-search__input es-subtitle-1"
        formControlName="text"
        [placeholder]="placeholder"
      />
      <button
        *ngIf="form.get('text').value"
        class="es-autocomplete-search__clear"
        mat-icon-button
        [attr.aria-label]="locale.autocompliteMultiple.labelClear"
        (click)="onClear()"
      >
        <mat-icon svgIcon="es-autocomplete-multiple:clear"></mat-icon>
      </button>
    </div>

    <div *ngIf="((filteredOptions$ | async) || []).length" class="es-autocomplete-multiple__menu">
      <button
        mat-button
        class="es-autocomplete-multiple__menu-button es-body-100"
        [attr.aria-label]="locale.autocompliteMultiple.labelChooseAll"
        (click)="onSelectAll()"
      >
        {{ locale.autocompliteMultiple.labelChooseAll }}
      </button>
      <button
        mat-button
        class="es-autocomplete-multiple__menu-button es-body-100"
        [attr.aria-label]="locale.autocompliteMultiple.labelRemoveChoice"
        (click)="onRemoveAll()"
      >
        {{ locale.autocompliteMultiple.labelRemoveChoice }}
      </button>
    </div>

    <mat-selection-list
      *ngIf="filteredOptions$ | async as options"
      class="es-autocomplete-multiple__options"
      color="primary"
      (selectionChange)="onSelectionChange($event)"
      #selectionList
    >
      <mat-list-option
        *ngFor="let option of options"
        class="es-autocomplete-multiple__option"
        [ngClass]="{ 'es-autocomplete-multiple__option_selected': matOption.selected }"
        checkboxPosition="before"
        [value]="option"
        [selected]="isSelected(option)"
        #matOption
      >
        {{ displayWith(option) }}
      </mat-list-option>
    </mat-selection-list>

    <div class="es-autocomplete-multiple__footer es-caption">
      <label>
        {{
          getShownCountInfo(
            locale.autocompliteMultiple.labelShown,
            locale.autocompliteMultiple.labelOf
          )
        }}</label
      >
      <label>{{ locale.autocompliteMultiple.labelSelected + ': ' + value.length }}</label>
    </div>
  </div>
</ng-template>
